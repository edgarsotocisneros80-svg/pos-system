// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  price       Decimal
  in_stock    Int
  category    String?
  category_id Int?
  categoryEntity Category? @relation(fields: [category_id], references: [id])
  barcode     String?   @unique
  order_items OrderItem[]
  purchase_items PurchaseItem[]
  stock_movements StockMovement[]
  adjustment_items InventoryAdjustmentItem[]
}

model Customer {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  phone      String?
  status     String?  // 'active' | 'inactive'
  created_at DateTime @default(now())
  orders     Order[]
}

model Order {
  id           Int           @id @default(autoincrement())
  customer     Customer?     @relation(fields: [customer_id], references: [id])
  customer_id  Int?
  total_amount Decimal
  status       String?       // 'pending' | 'completed' | 'cancelled'
  created_at   DateTime      @default(now())
  items        OrderItem[]
  transactions Transaction[]
  stock_moves  StockMovement[]
}

model OrderItem {
  id         Int     @id @default(autoincrement())
  order      Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  order_id   Int
  product    Product @relation(fields: [product_id], references: [id])
  product_id Int
  quantity   Int
  price      Decimal
}

model PaymentMethod {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  transactions Transaction[]
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  slug        String     @unique
  code        String?    @unique
  description String?
  parent_id   Int?
  parent      Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  is_active   Boolean    @default(true)
  sort_order  Int        @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt
  products    Product[]
}

model Transaction {
  id                Int            @id @default(autoincrement())
  description       String?
  order             Order?         @relation(fields: [order_id], references: [id])
  order_id          Int?
  purchase          Purchase?      @relation(fields: [purchase_id], references: [id])
  purchase_id       Int?           @unique
  payment_method    PaymentMethod? @relation(fields: [payment_method_id], references: [id])
  payment_method_id Int?
  amount            Decimal
  type              TransactionType
  category          String?
  status            String?        // 'pending' | 'completed' | 'failed'
  created_at        DateTime       @default(now())
}

enum TransactionType {
  income
  expense
}

// Inventory & Purchasing

model Supplier {
  id          Int       @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  address     String?
  tax_id      String?
  status      String?  // 'active' | 'inactive'
  created_at  DateTime @default(now())
  purchases   Purchase[]
  payables    Payable[]
}

model Purchase {
  id            Int         @id @default(autoincrement())
  supplier      Supplier    @relation(fields: [supplier_id], references: [id])
  supplier_id   Int
  total_amount  Decimal
  status        String?     // 'pending' | 'completed' | 'cancelled'
  payment_term  String?     // 'cash' | 'credit'
  due_date      DateTime?
  created_at    DateTime    @default(now())
  items         PurchaseItem[]
  transaction   Transaction?
  payable       Payable?
  stock_moves   StockMovement[]
}

model PurchaseItem {
  id           Int     @id @default(autoincrement())
  purchase     Purchase @relation(fields: [purchase_id], references: [id], onDelete: Cascade)
  purchase_id  Int
  product      Product  @relation(fields: [product_id], references: [id])
  product_id   Int
  quantity     Int
  price        Decimal
}

model Payable {
  id           Int       @id @default(autoincrement())
  supplier     Supplier  @relation(fields: [supplier_id], references: [id])
  supplier_id  Int
  purchase     Purchase? @relation(fields: [purchase_id], references: [id])
  purchase_id  Int?      @unique
  amount       Decimal
  balance      Decimal
  status       String?   // 'open' | 'paid' | 'cancelled'
  due_date     DateTime?
  created_at   DateTime  @default(now())
  payments     PayablePayment[]
}

model PayablePayment {
  id          Int      @id @default(autoincrement())
  payable     Payable  @relation(fields: [payable_id], references: [id])
  payable_id  Int
  amount      Decimal
  paid_at     DateTime @default(now())
}

model StockMovement {
  id            Int                 @id @default(autoincrement())
  product       Product             @relation(fields: [product_id], references: [id])
  product_id    Int
  quantity      Int                 // positive for IN, negative for OUT
  type          String              // 'purchase' | 'sale' | 'adjustment'
  order         Order?              @relation(fields: [order_id], references: [id])
  order_id      Int?
  purchase      Purchase?           @relation(fields: [purchase_id], references: [id])
  purchase_id   Int?
  adjustment    InventoryAdjustment? @relation(fields: [adjustment_id], references: [id])
  adjustment_id Int?
  unit_cost     Decimal?
  created_at    DateTime            @default(now())
}

model InventoryAdjustment {
  id          Int        @id @default(autoincrement())
  reason      String?
  created_at  DateTime   @default(now())
  items       InventoryAdjustmentItem[]
  stock_moves StockMovement[]
}

model InventoryAdjustmentItem {
  id             Int                 @id @default(autoincrement())
  adjustment     InventoryAdjustment @relation(fields: [adjustment_id], references: [id], onDelete: Cascade)
  adjustment_id  Int
  product        Product             @relation(fields: [product_id], references: [id])
  product_id     Int
  quantity       Int
  note           String?
}
